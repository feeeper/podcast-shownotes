[
  {
    "segment_id": "35810f63-ff99-479c-af2a-631a3a83a850",
    "episode_id": "740f1007-fa72-4a05-b0d9-2393c115bf2a",
    "episode_number": 104,
    "segment_number": 13,
    "text": "конфигом так, чтобы стейт пришел в такое состояние, как вам надо. Теперь наконец есть команды для, ну команды командной строки, для того, чтобы просто вот там переименовать, например, кусок стейта, или что-то в нем поправить, это довольно здорово. Второй момент, это наконец есть нормальная возможность передавать списки и типы, вот то есть там, если у вас есть несколько терраформов, либо это молды разные, либо это у вас там какой-то у нас есть стейт на С3, у нас на самом деле разные окружения, их менеджат разные кусочки терраформа, и некоторые окружения, они знают про некоторые другие окружения, то есть, например, у нас есть окружение, которое отвечает за VPC и настраивает глобальную сеть как бы во всех остальных окружениях, а дальше все остальные окружения, там CI, Staging, Production и так далее, они берут как бы сети из этого общего окружения, которое менеджит сети. Вот, это делается через эксперт переменных. Там был такой интересный момент, что раньше вот несмотря на то, что в терраформе в самом, как бы руками можно написать всякие и мэпы, можно было написать и списки, вот передать их как переменные из одного места в другое было нельзя, и приходилось их как бы конкурировать в строку, а потом разбирать обратно, что геморрой не нужно, и еще и местами нетривиально заставить работать. Если структура данных какая-нибудь, ну, там, например, в список нужно собрать что-то, что где разделитель является, может оказаться и внутри элемента списка. Вот. Наконец это починили, и теперь есть нормальная поддержка и списков, и мэпов. Ура-ура. Изменения, как бы из вещей, которые менее полезны для пользователя, мне кажется, изменения ради просто идеологической чистоты. Долгое время были ресурсы в терраформе, которыми нельзя управлять, потому что ну вот как можно управлять вашим списком AMI на Амазоне? Ну, никак. Это просто, это именно что вот какой-то такой ресурс, который... Просто данных. Это просто данные. Да, это просто данные, вот оно у вас такое. И чтобы, ну а у терраформа, у любого ресурса, у него должно быть create, read, update, delete. Ну, update, кстати, может не быть. Create, read, delete должны быть обязательно. Ну и чтобы не заниматься вот такой фигней, они наконец-то сделали отдельный концепт data sources, которые вот просто read-only какие-то источники. Больше того, как побочный эффект, они, который видно пользователю, они сказали, что теперь вот многие поля, которые раньше были просто компьютеры без подробностей, теперь для read-only источников они могут просто заранее, поскольку это read-only, они знают, что с ними ничего не может случиться, они могут заранее просто данные зафетчить и вместо компьютера подставить, ну, что там, собственно, будет, потому что все равно из источника прилетело, которое не меняется. По крайней мере, не меняется, в зависимости от вашего конфига. И еще одно такое важное изменение, это импорт. Я, честно говоря, не очень понимаю, зачем это. То есть я понимаю, какое желание у меня должно быть, чтобы написать вот этот импорт, но непонятно, почему я не могу это сделать раньше. То есть если у вас есть какой-то кусок инфраструктуры, который еще не манажится терраформом, вы можете написать импорт, он у вас окажется в стейте, а потом вы можете написать конфиг, покуда у вас план не начнет показывать нулевую дельту. То есть вы вот заимпортировали что-то, а потом начинаете писать терраформерский скрипт и запускаете периодически терраформ-план и смотрите, что-то будет у вас, хочет ли терраформ сделать какое-то изменение. Когда терраформ не хочет делать больше никаких изменений, это значит, что вот то, что вы написали в своем скрипте, оно соответствует тому, что у вас в инфраструктуре. Мне это немножко непонятно, потому что я ведь, в общем-то, и так могу так сделать. Я не понимаю, зачем мне нужен отдельный шаг импорта. То есть я могу создать какой-то объект в терраформе, ой, сори, в Амазоне ручками, потом написать конфиг в терраформ-скрипте, который просто будет пустой, просто объявляет ресурсы таким же одним как бы неймом или чем-то еще уникальным. И как бы терраформ, как правило... Я не знаю, может, они работают с инстанциями Амазона, потому что у них там айдишники всегда совсем рандомной генерации. Но с чем-то типа RDS, когда там, в принципе, фиксировано имя, но оно работает и без всякого импорта. Вот. Это, пожалуй, вот обзор изменений в новом терраформе. И почему может хотеться на него вообще обновиться. Я открыл changelog на гитхабе. Он большой, changelog... Это просто невероятно. Он огромен. Ну там еще знаешь, в чем дело? Чангелог на гитхабе, его смотреть вредно тем, что у них файл changelog, он общий вообще на все. То есть там все релизы, которые терраформа есть, они... Там же, когда ты быстро скроллишь, очень легко не заметить, что ты уже читаешь версию 0.6, например. Пересмотрись. Я вижу 0. 6. На самом деле он во многом только большой, мне кажется, потому что они же... Понятно, что там дофига bugfixes, но там же наверняка еще и дофига... Как это? Перестало быть ресурсом, стало data source. Я почти уверен, что вот там такого добра очень много. Когда change просто потому, что они меняли API много где. Заодно и там поменяли. Тут больше всего изменений в провайдере AWS. Ну да. Что вполне логично. Надо понимательнее поглядеть все эти тикеты. А эти... Репликашн группы для эластикасов до сих пор не сделали за санкции. Я, кстати, могу немножко пожаловаться, а может кто-нибудь даже придет мне, расскажет, что я делаю не так. Я пытаюсь вот в своем плагине для терраформа сделать придержку тегов. Казалось бы, это такая элементарная вещь, которая есть просто во всем, что есть в Амазоне. Но почти как бы для манипуляции с тегами нужно построить этот IRM. И я как-то так и не понял, как мне для репликашн групп какой там тип ресурса. Если поставить в качестве типа ресурса репликашн групп, это не работает. Вот я немножко офигеваю, потому что я не могу понять, а как мне теги-то проставить. Или мне нужно идти просто на каждую машину и проставлять теги. Я же талабанусь. Могу я задать тупой вопрос? Да. Мне откровенно непонятно, зачем ты так страдаешь. У нас в свое время был проект на Амазоне. Мы просто написали скриптов, которые через его API прямо делают то, что нам надо. Вот ровно то, что нам надо. И не было, ну как бы с точки зрения того, что в Амазоне иногда чуть-чуть что-то не работает, или чуть-чуть меняется, ну как бы такие маленькие проблемы. Но в целом оно хорошо работало. Вот этот терраформ и так далее, зачем это тебе? Ну смотри, если абстрагироваться от того, что я пишу плагин, а затем, что, во-первых, писать меньше, реально меньше. Ты пишешь там несколько строчек, а он тебя разворачивает в свою инфраструктуру. Слушай, я могу найти скрипты, я их писал там типа один спринт неделю. Мы их пишем сколько, два дня, у нас почти все развернуто уже. Мы сейчас работаем уже именно, что мы полируем как бы внутренности машин уже, а не инфраструктуру на Амазоне. Ты говоришь, вы, вас больше одного, а я это писал один. У нас больше одного, но мы как это, у нас с PR программников все поля, мы не параллелимся. Ну у нас тоже скудрюбью вот этим всем. Ну это на самом деле не суть важная, ну то есть типа 5 дней или 3 дня, это как бы согласиться не в долгосрочной перспективе. Это первый момент, второй момент. Терраформ именно, что вот в отличие от многих скриптов, он не так, что вот есть набор команд, он их все выполнит. Если что-то уже создано, он обломает, что такое терраформ. Он именно, что у него концептуальное отличие от многого чего другого, что у тебя есть какое-то описанное состояние в конфиге. Есть состояние того кластера, терраформ понимает в чем разница между этими двумя описанными состояниями. И будет старательно приводить твой кластер в то состояние, которое ты хочешь. Меня это пугает, честно. Почему? Это как раз вот, блин, вот... Это чрезвычайно удобно. Да, ну то есть если ты знаешь, что терраформ отработал и не обломался, ты знаешь, что у тебя состояние кластера точно такое, как у тебя написано в конфиге. Если он обломался, ты стоишь сюда багов и всяких другой фигни. Ну вот приведи мне багов, примеры. Начнем с этого. Не, ну у нас были баги с терраформом, но даже с учетом багов, это все равно совсем другое. То есть лишний запуск скрипта, скажем, у тебя депотенность автоматически появляется. Лишний запуск скрипта тебе ничего не сломает, ничего не добавит, лишнего не убьет и так далее. Потом у тебя легко, ты менеджируешь ресурсы, то есть у нас, скажем, 5 кластеров. У нас теперь 5 стейтов хранится где-то в репозитории. Любой человек может прийти и погасить этот стейт или обновить его, или сделать еще что-нибудь такое. То есть это настолько, как управление кластерами, управление ресурсами в Амазоне с помощью терраформа, настолько удобно им становится после того, как ты на терраформ переходишь. Я могу тебе реальный кейс рассказать. Подожди, подожди, я еще немножко Ваню наполню. Там есть еще, вот он сказал, что неважно, сколько раз ты скрипт запустил, больше того, если у тебя во время какого-то прогона скрипта что-то сломалось, не знаю, у тебя фруктуация континуума Амазона, у тебя репликашн группа создается не 20 минут, как обычно, а весь час. И понятное дело, что твой терраформ Apply, например, затаймаутился наполовину. Очень большой плюс терраформа в том, что ты его второй раз запустил, ну то есть дождался, когда он там реально создастся, второй раз запустил, и он доделывает недоделанные. Как бы его доведет до... Реальный пример рассказываю. Были скрипты работающие, продоссированные, которые катили на Амазон. Одним прекрасным утром чувак приходит на работу, запускает скрипты, они отлично отрабатывают, в стейк отработал, количество машин такое, какое нужно. Ну представим, что это терраформ, набор скриптов. Одна проблема, приложение оно в старой версии осталось, потому что Амазон чуть-чуть немножко поменял что-то в своем IP. Как ты это отлаживать будешь? В случае терраформа? Да, то есть у тебя в терраформе багов нет, проблема в том, что Амазон чуть-чуть что-то поменял. Ну запустил терраформ Apply с дебаг опцией, он тебе вывел всю коммуникацию с Амазоном. Так, но он тебе выводит, что да, я там типа создаю виртуалки, прибиваю старые виртуалки, у меня там выкатились новые виртуалки. Нет, в смысле ты видишь прям коммуникацию по протоколу XML на Амазон. Ну хорошо, ты видишь там гору XML, дальше твои действия. Ну ты же видишь, что тебе Амазон отвечает. Ну вижу. Как бы видишь, какие у тебя могут быть проблемы. Ну то есть ты вот это будешь дебажить, да? Нет, в смысле, тебе в любом случае нужно понять, что не работает, что в скриптах, что в терраформе. Тебе нужно понять, во-первых, какой шаг у тебя, на каком шаге у тебя возвращается какая-то фигня от Амазона, или на каком шаге Амазон делает тебе то, что ты от него ожидаешь. Конкретно в этом случае у тебя во всех шагах возвращаются правильные данные и происходит то, что ты хочешь. Но? Но приложение остается старой версией. А при чем здесь терраформ тогда? Так проблема-то не в терраформе, в нем багов нет. У тебя проблема в том, что Амазон теперь работает не так, как под что терраформ был написан. Я не вижу здесь правильности между своими скриптами и терраформом. А ты знаешь, как написаны твои скрипты и что конкретно они делают. Я также знаю, что делает терраформ. И сколько там в нем кода в терраформе? Ну кстати не так много. Ты понимаешь, я свой плагин написал не за счет того, что я магически понял, как его писать, а потому что я читал код терраформа и писал свой плагин. Точнее копипастил свой плагин из кода терраформа местами. Там все довольно очевидно, там реально можно перейти просто в сарец и начать его читать. Там никакой ракетной магии нет. То есть там да, то, на что я ругался, есть каст из интерфейса и обратно, но это вот побрюшал я и ладно, а читается оно на ура. Это не сложнее своих скриптов и возможно даже проще. Ты всегда можешь запустить, вот как правильно Полерас сказал, с опцией и ты будешь видеть, что он делает. То есть это не только на уровне, я хочу к этому стейту прийти, а он показывает шаги, какие он запускает для того, чтобы прийти, ты это все видишь. Вот пока вы говорили, я в прямом очереди скачал исходники терраформа. Там они к счастью хорошо пожаты. Вот сейчас посмотрим, сколько там кода. Ну ты не смотри на все, тебе нужен AWS. В смысле не смотри на все? Смотри, тебе нужен AWS, смотри в AWS провайдер. Там провайдеры под кучу платформ. Тебе нужен AWS, смотри в AWS. Ты мне только что говорил, что ты знаешь, как работает терраформа и что там мало кода. Вот я посчитал, окей. В терраформе почти один миллион строк кода на го. Ты хочешь сказать, что ты знаешь, как это работает? Нет, я знаю, как работает AWS. Мне этого достаточно, чтобы отлаживать AWS. Никто, кроме инженеров AWS, не знает, как оно работает до ити, не все знают. Я имею в виду, как работает AWS плагин для терраформы. Ну, я так понимаю, мы не пройдем здесь к консенсусу, а типа, чтобы завершить историю, там конкретно была проблема в том, что Amazon в какой-то момент решил, что когда ты, ну то есть как раньше работало, ты берешь автоскилинг группу, меняешь у нее AMI в свойствах, потом удваиваешь размер автоскилинг группы и делишь на два. При этом у тебя создаются новые виртуалки из нового AMI. Когда ты уменьшил размер группы, у тебя прибиваются наиболее старые виртуалки со старым AMI. Таким образом у тебя происходит апдейт. А изменение в IP, ну как бы в поведении Amazon заключалось в том, что он палил, что у тебя поменялось значение с одного на другое, а потом на то, что было, и ничего не катил. И вот честно, как в миллионе строк, ну хорошо, пусть там не миллион, пусть там AWS провайдер, не знаю, 200 тысяч, ну хорошо, 100 тысяч. Слушай, он сильно меньше. Да не важно, я не понимаю, как это можно быстро и легко отладить. Скрипт на питоне, там 100 строк, там трудно его не отладить. Не, ну еще знаешь, ты сейчас приводишь такой пример, конкретно в том примере, который ты приводишь, это уже не с коптера форма. Ты не сделаешь раскатку приложения терраформом. Терраформ, он для того, чтобы положить тебе, как бы разложить тебе инфраструктуру. Вы только что мне говорили, что он приводит состояние кластера в состояние, которое я указал в конфиге. Да, но это не про приложение. И не про раскладку вообще ни разу нет. Ну вот именно, что это совсем ни разу не про раскладку. В смысле у меня в конфиге я сказал, что новую версию использовать. Вот версия, это уже не скоп терраформа. Ты терраформа говоришь, хочу столько-то AWS инстансов с такой-то AMI, с такой-то сеть, с такой-то, как это, боже. Секьюрити группы, вот это все. Load balancing, PC и прочее. Ролл 53, вот это все. Вот это все настроилось, все, что внутри машины, ты там, не знаю, может быть, Cloudynet скажешь, Cloudynet возьми оттуда, все. Ты на этом терраформ закончился. В чате правильно пишут, Вячеслав Вахашов, что это очередной холивар на тему свой велосипед, либо готовое решение. Всем известно, что велосипеду лучше. Конечно. Вот, а тем временем я хотел рассказать про несколько пейперов интересных, которые появились в паблике на этой неделе. Сейчас проходит конференция Black Hat USA с 30 июля по 4 августа она проходила. И по этому поводу разные рарные PDF были залиты. Первая рарная PDF, она про уязвимости в протоколе HTTP 2. Нашли 100-500 багов. Ну, не 100-500, на самом деле 4, но все очень серьезные. То есть оказалось, что, ну, как бы TLDR этим пользоваться нельзя. То есть объективно нельзя. Подробности следующие, что есть, ну, речь идет про конкретные реализации серверов, да, и про баги, которые в них есть. Уязвимости к slow read, то есть читаем по одному байтику из стрима, серверу становится очень плохо. Еще в HTTP 2 есть поддержка сжатия заголовков и так далее. Вот, атака называется HPEG bomb. То есть мы можем там в заголовке сжать какой-нибудь длиннющий-длиннющий заголовок, он хорошо сожмется, посылать его на сервер, он разожмет его, не знаю, в 500 МБ памяти, все будет очень плохо. Еще одна уязвимость, она в ng-httpd, по-моему, так называется сервер. Я так понял, это деталь конкретной реализации, что там строится некая цепочка зависимости в памяти, и при определенных условиях ты можешь эту цепочку превратить в цикл. Извините, перебью, на самом деле это в целом же проблема, мне кажется, как раз от HTTP 2 протокола, то, что у тебя стримы могут зависеть друг от друга, насколько я помню. И если у тебя стримы могут зависеть друг от друга, это такая бомба замедленного действия. Чья-то реализация непременно начнет строить граф, который получится цикленный. И никак не будет этого защищена. Ну, строго говоря, ты можешь проверить, что граф не циклический, но да, это беда. Ну, в смысле, это легко поиском ширину, например, проверяется, что у тебя там ноды не встретятся дважды. Но это дорогая операция, то есть нужно как-то ограничивать размер вообще графа, например. И еще одна проблема, я, честно говоря, ее плохо понял. Stream Multiplexing Abuse. Есть CVA на эту тему. Я так понимаю, что можно слать очень-очень много запросов, не дожидаясь ответов, и серверу станет плохо, потому что он будет в стрим пытаться слать 100-500 респонсов, которые накопились. Вообще вердикт авторы этого PDF делают такий, что, ну, как любая новая технология, которую Google в тропях выкатил в свои браузеры и на свои сервера, чтобы платить поменьше бабла за сервера, она не протестирована, уязвима и пройдет еще много-много времени, пока этим можно будет сравнительно безопасно пользоваться. Не спешите переходить на все новое блестящее, используйте HTTP 1, который нам сравнительно неплохо и долго служит. И второй крутой пейпер, я начну немножко издалека. Есть такое мероприятие, называется pwn2own. Это своего рода ICFP в мире информационной безопасности. То есть, как это примерно выглядит. На конференции, я не помню, как называется конференция, на которой это проходит, собираются команды, которые должны что-то поломать, но они пока не знают, что им предстоит поломать, чтобы нельзя было к этому подготовиться. Например, перед ними ставят MacBook. Говорят, вот у нас Mac, мы его вчера купили в App Store, или как это называется, короче, в официальном магазине Apple, поставили на него последних апдейтов и так далее. Ваша задача – получить на нем рута. Вам на это дается 3 дня, и по стечению времени у вас условия будут становиться все круче и круче. Там, условно говоря, в первый день мы вас пустим на 5 минут в одну Wi-Fi-сетку с этим компом, можете попытаться его удаленно сломать. На второй день вы можете нам присылать каких-нибудь линков, и мы в трех разных браузерах их откроем. А на третий день вы можете воткнуть в этот Mac флешку на какое-то время, потом ее оттуда достать. Вот все, что вы можете, ломайте как хотите. Проходит это мероприятие уже довольно давно, с 2007 года, если не ошибаюсь, и на нем регулярно находят разные крутейшие уязвимости, которые не были до этого известны. И Paper, он на том, ну там такое краткое summary, там с 2013 года он делает summary того, что находили, какие уязвимости конкретно в браузерах. Да, и все это с денежными призами, разумеется, я не помню, там точно призовый фонд, типа 10 тысяч долларов, по-моему. Нормально, да, для трех дней работы. Почитайте, это очень интересный Paper, там есть примеры кода, HTML, JavaScript, вот это все, есть подробное описание, где чего сломалось, как это патчили и так далее. У меня, наверное, на этом все. Слушай, интересно, а как они, меня интересует, как они за три дня могут вообще найти что-то серьезное, настолько серьезное, что там специалисты они находили под опасностью. Ну, во-первых, там как бы команда, это не один человек делает, они исследуют, ну они в параллеле просто работают, насколько я понимаю. Ну, как, они пьют много Red Bull'а и им предложили много денег. И они профессионалы. Ну, да, и они реально очень умные чуваки, которые на этом специализируются. Так что, ну, если вам кажется, что ваш браузер и система безопасны, это, ну, подумайте еще раз. Просто вопрос в том, насколько кому-нибудь хочется найти там багов.",
    "result": {
      "query": "новое в terraform changelog"
    }
  }
]