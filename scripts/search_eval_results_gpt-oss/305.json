[
  {
    "segment_id": "c4ecf45b-ae95-47cc-b7ed-363583f5cc6b",
    "episode_id": "a67a2ba1-6f50-4479-8c4a-2d0f2db5ce61",
    "episode_number": 305,
    "segment_number": 5,
    "text": "Когда-то наступит замечательное будущее, когда у нас по дому будут летать квадрокоптеры, которые убирают пыль, и, там, не знаю, протирают экран у мака и вот это вот все. Я знаю, что есть работы, которые ползают по стеклу, там типа моют небоскребы снаружи, вот, но я хочу, чтобы у меня летал дрон и убирал пыль. Вещи раскладывал. Нет, нет, есть же, Саша, такие штуки, что есть же специально автоматизированные эти системы по уборке пыли, они устраивают твою квартиру и они работают так, что есть такие, как бы, всасыватели пыли, которые возле принтуз расположены, и оно работает постоянно, и в итоге у тебя, в принципе, меньше пыли в квартире, потому что постоянно воздух очищается. Вот такие штуки я слышала. Я не знаю, как оно называется, но мои знакомые рассказывали о таких системах и вроде какой-то самый эффективный способ. Мне кажется, Кэджи Цин немножко затянулся. Да, я хочу сказать, что вот этот всасыватель у Плинтуса звучит как, ну, я как-то скептически настроен, просто пыль это в основном частички твоей же кожи и какая-то еще мелкая фигня, которая в воздухе летает, и она, в принципе, может осядить где угодно, не обязательно у Плинтуса, то есть то, что ты там всякие вещи... Ну, не, пойнт том, что постоянно это делает, у тебя воздух очищается, понимаешь? Так же пересушивается и до негативное давление. Ну, ты скажешь негативные энергии. Да, мы в ДВЗ не любим, когда давление в несколько атмосфер, поэтому давайте поднимем уровень давления. У кого уровень давления высокий, это у АМД. Это моя тема. Я принес ее к прошлому выпуску, начал заныривать в этот квалифичный нор и понял, что она слишком глубока. Начал я в нее заныривать, поскольку в Гугле анонсировали новые защищенные типы инстанцев, которые не просто защищенные, а супер защищенные. Я про это отдельно потом расскажу. Но когда я начал читать про эти типы инстанцев, оказалось, что они базируются на АМД-шных новых типах процессоров и, соответственно, системах, основанных на этих процессорах. И надо читать, что это такое в целом. И я начал читать, оказалось, что есть несколько статей на эту тему. И я взял первую попавшуюся статью и начал ее читать и понял, что здесь будет серия, наверное. Потому что прямо сейчас мы обсудим WhitePaper по поводу архитектуры АМД-ССП. Я там чуть попозже расшифрую, что это такое. И, возможно, потом, если будет интересно, оставшийся материал мы покроем как-нибудь отдельно. СЭФ – это Secure Encrypted Virtualization. СНП – это новый Secure Nested Paging. То есть там на самом деле это постепенное изменение. То есть вот этот СЭФ – Secure Nested Virtualization. Как-то безопасная, да? Безопасная фиртуализация. Она вводилась в несколько этапов. Вот сейчас наступил третий этап. WhitePaper уже объявлен. И, соответственно, архитектура уже появляется. Но я так понимаю, что будет еще четвертый этап, пятый этап и так далее. Я пока не смотрел, что именно использует Google. Google говорит, что мы уже это можем делать. Но давайте еще немножко подождите. Поэтому пользоваться этим пока мы не можем. Ну, короче, все по порядку. Начнем издалека. Во-первых, кто-нибудь из вас… Нет, давайте начнем с другой стороны. Смотрите, мы все из дома пользуемся какими-то устройствами, в которых чаще всего есть процессоры. Они есть во всем, начиная вот с того робота-пылесоса, который сейчас что-то записывает и посылает все товарищу майору. Не заканчивая современно… Что-то достаточно бессмысленное, потому что мы все равно выложим. Да, кстати, да. И при этом будет только частички и голос. И заработает на этом только компания, которая продает маршетизаторы. А в современных утюгах, я не знаю, чайниках и так далее тоже есть какие-то маленькие свои устройства управления, которые со временем тоже научатся подключаться к интернету, выходить и покупать запасной фильтр, который давно проходил, всегда надо было купить на Амазоне. Выходить из этого устройства. Я сказала так, выходить, и вы узнаете, они так оживают, выходят из устройства и что-то делают. А я думаю, что так будет. Он спит два месяца, а потом просыпается и такой, о, я проснулся, ну-ка, я купил, я заснул. Наверное, так и есть. И чаще всего это очень простые устройства, потому что в них нет системы, которая пытается ввести сложную зеркализацию для того, чтобы можно было запустить на большое количество зеркальных машин. И докеров. Да, да, да, и докеров. Как те процессоры, которых мы будем осуждать сегодня. Но иногда необходимо иметь системы, не знаю, для того, чтобы запускать на них совершенно разных пользователей. Ну, скажем, когда вы заходите в облако и запускаете новый инстанс в Амазоне, вы запускаетесь, ведь, понятно дело, на обычном процессоре, на обычной системе, но вам выделяется только часть этого процессора, часть этой системы. И кто-то еще одновременно использует, скорее всего, настоящий железный инстанс. И для того, чтобы вы с этим человеком как можно меньше пересекались, не только с точки зрения того, что в ресурсе друг друга можете красть, но также с точки зрения того, что, если вы хорошо знаете эту архитектуру, вы можете как-нибудь влезть в гипервизор, который управляет этими виртуальными машинами, и что-то стащить из того соседа, который там что-то где-то запускает. Я, если честно, пока не помню, были ли подобные утечки объявлены, были или нет, что кто-то влез и через гипервизор сломал и утащил. Чаще всего было известно про какие-то баги, которые компании спешно закрывают, то есть, не знаю, останавливают какие-то старые версии гипервизоров, или, там, не знаю, патчат какие-то свои коды, которые позволяют запускать виртуальные машины более секьюрно. Но я просто к тому, что вот этот тип процессоров, он совершенно другой. И чаще всего мы не мыслим, мы как обычные пользователи не мыслим... Прошу прощения, машина ездит сильно слышно, нет? Стоит закрыть окно. Вообще не слышно. Отлично. Мы, как обычные пользователи, мы вообще не мыслим этими категориями. Не знаю, давно ли вы задумывались, я не знаю, как запустить на своей системе такую программу, которая будет неспособна достучаться другой программой, внутри себя сможет запустить операционную систему и так далее и так далее. Иaky. Я, например, я пытаюсь забыть предыдущую работу, давай на другую часть. Да. Мы сегодня, кстати, про это тоже немножечко зацепим. И когда начинаешь читать decir подобную статью, надо немножечко separнуть голову. Надо немножечко separнуть голову, потому что надо включить следующий уровень паранойи. То есть мы всегда немножечко параноиды это подкасти, а когда читаешь подобную статью, надо включить следующий уровень паранойи, потому что иначе ты вообще не понимаешь, нафиг они это делают. Я когда прочитал то количество изменений в архитектуре, которые они запилили, я понимаю, что мы просто так греем воздух и столько всего выполняем только для того, чтобы обезопасить кого-то от кого-то, работающий на твоих железяках. Ну то есть это настолько исключительный случай, и я понимаю, что, я не знаю, вот как мне жалко то электричество, которое сжется для того, чтобы биткоин поддерживать, так и мне жалко то электричество, которое мы поддерживаем и используем для того, чтобы вот здесь вот безопасность шифрования сделать внутри этих инстанцев. Вот. Давайте пойдем по очереди. Итак, компания AMD в 2016 году представила новый тип зеркализации, который называется Secure Encrypted Zertalization SEV. Это первая версия в линейке, которая позволила изолировать виртуальные машины от гипервизора. Гипервизор – это для тех, кто совсем не в курсе, простым языком, вы на своих инстанцах, вы компании, например, Google или Amazon, ставите все машины в дата-центр, на этих машинах вы запускаете операционную систему, и это и счастливый. Нет, на самом деле нет. Вы запускаете гипервизор, который будет запускать виртуальные машины на ваших инстанцах и позволять их резать в какую-то, не знаю, одну большую машину, на которой 60 процессоров вы разделяете, позволите разделить на 30 разных машин по 2 процессора, и они будут запускать свою операционную систему. Любая SATA-операционная системы будет обращаться к вашей операционной системе, когда нужно что-то сделать. Эти виртуальные машиныacking not dependent, для того чтобы изолировать эти виртуальные машины от гипервизора, для того чтобы ввести первую версию безопасности, для каждой виртуальной машины, который запускал гипервизор, вводился специальный IS-ключ, IS-encrypted key, encryption key, и соответственно вся память, с которой работала эта виртуальная машина, она криптовалась. Валера, у тебя опять микрофон включился. И в случае взлома гипервизора, он даже если мог прочитать всю память, потому что он-то гипервизор, он управляет всем, чем можно, он не мог прочитать память, точнее он мог прочитать, но не мог ее расшифровать. Эти ключи хранились в той части системы, которая не управлялась гипервизором, он не мог это сделать напрямую. А виртуальные машины прозрачно читали и на лету расшифровывали данные. Это делалось как раз с помощью дополнительных изменений в самом железе. Это позволяло обходить гипервизор в этой процедуре обращения к памяти. Тут надо пояснить, что когда вы работаете в таких сложных системах, всегда есть какая-то часть железа, который вы доверяете, и программного обеспечения, который вы доверяете, и всегда есть часть, которой вы не доверяете. То есть в первой части, в первой версии, гипервизор был той частью системы, о которой мы доверяли, но на всякий случай начинали от нее немножко защищаться. Чем более старшее поколение безопасной виртуализации у AMD, тем большее количество подсистем мы можем считать потенциально взламываемым и мы можем не доверять. Чем дальше, тем меньше систем, которым мы обязаны доверять, для того чтобы построить безопасную виртуализацию. Пока понятно, о чем я говорю? Может какие-нибудь вопросы? Сложно. Поди, мы только начали. В 2017 году появилась следующая версия этого SEVA, называлась SEVEs, encrypted state. То есть мало того, что это SEV, это сам по себе secure encrypted fertilization. Он появился еще, encrypted state поверх него. Он добавил то, что было проблемой в первой версии, а именно когда вы работаете с процессором, вы всю необходимую для работы информацию сохраняете в регистре, когда вам надо как-то с чем-то работать. Соответственно, эти регистры гипервизор имел право читать. Если вы какую-то секретную информацию положили в регистре, то он мог все это прочитать. Из-за того, что гипервизор управляет всеми виртуальными машинами, получается, что гипервизор может прочитать регистры всех виртуальных машин, конечно, при правильной организации работы взлома и гипервизора. В следующей версии вы этим же ключом, AES ключом, вы шифровали не только состояние памяти, но и состояние регистров. Гипервизор получал значение, то, что хранится во всех регистрах, но он получал не расшифрованное значение, а расшифрование делалось только виртуальными машинами. И наконец, вот здесь не написано, к сожалению, в каком году, надо бы посмотреть, появился Secure Nested Paging, это последняя версия, про которую мы сейчас будем говорить. Это более сложная система, которая большое количество изменений в железе потребовала, и помимо вот этих двух предыдущих ступеней, она включает и более сложную работу с памятью, такую, что... я даже не знаю сейчас, как правильно сделать обобщение. Нет, давайте не буду делать обобщение, потому что это сложно. Идея в том, что гипервизор в текущей системе, он теперь считается полностью системой, которой мы не дозеряем вообще никогда. То есть, в этой последней версии релиза, системой, которой мы доверяем, это становится только сам ЦПУ, все, что вокруг ЦПУ, и AMD Hardware and Firmware для этого Hardware. Прошу вращения за такие банальности. И получается, что мы доверяем самой вертолиальной машине, которую создали, мы доверяем самому ЦПУ и обвязки вокруг ЦПУ, но мы не доверяем гипервизору полностью, мы можем вообще считать, что он всегда взломан, и между тем он не сможет нам полностью сломать работу. Есть несколько направлений атак, которые взломаются в работу. Если вы сломали гипервизор и перенастраивали так, чтобы она в вертолиальной машине не давала времени на управление процессором, то соответственно та вертолиальная машина не будет стартовать, и вы никогда не получите сделанную работу, потому что у нее вообще ноль процессорного времени. Такую атаку от такой атаки защититься невозможно. Но если гипервизор будет давать работу, то он не сможет не прочитать данные, не записать некорректные данные, не сделать какую-то более сложную атаку, когда там хитрая работа с памятью, или прочее-прочее. Это делается с помощью большого количества изменений, которые на самом деле... Когда начинаешь читать эту статью, понимаешь, что идея здравая, то есть ты хочешь запускать в облаках какие-то изертуальные машины, но не хочешь, чтобы их взламывали, информацию на них считывали или давали им некорректную информацию, это прям классная идея. Но как это реализовать, на самом деле придумать очень сложно. Сама система у нас сейчас, все компьютеры, все эти инстанции, работа с нетворком, с памятью, с регистрами, с... Не знаю, вообще само по себе, сама индустрия, она дошла до уже до сих пор, прям большой-большой сложности, если вы почитаете, как это все работает. И добавить сюда еще один слой абстракции, добавить еще один слой защиты, это... Я человек, немножечко касающийся этого, я понимаю, что мне не хватит информации для того, чтобы это правильно придумать. Я прям преклоняюсь перед теми людьми, которые это делают. Так, давайте я все пропущу, что не интересно. И расскажу то, что мне интересно. Так, это я пропускаю, это я пропускаю, да. Во-первых, статье дается очень интересная информация про то, какие атаки вообще существуют. И этим мне очень статья понравилась. То есть они не пытаются сказать, что, ребята, мы защитим от всего подряд. Они перечисляют все типы атак, которые вообще производятся на виртуальные машины. И со сломанным гипервизором, не со сломанным гипервизором пытаются объяснить, каким образом у них защита работает. И в том числе есть некоторые атаки, против которых они принципиально не могут сделать никакой защиты. И соответственно, они все типы архитектуры, вот этот SEV, SEF ES и SEF SNP, они перечисляют и показывают там прям табличка такая. Вот здесь галочка, значит, защита есть. Нет галочки защиты, нет. Вот один из типов атаки, гипервизор не даст вашей в виртуальной машине управление. То есть полностью сломанный гипервизор, ну, значит, тип атаки успешный и от него защититься нельзя. Они честно здесь сообщают. И еще некоторые ряд атак, которые они тоже говорят, что мы не можем от него никак защитить. При том они довольно внятно перечисляют все виды атак, каким образом эти атаки могут применяться, каким образом они применяются на той же AMD, скажем, ES, более упрощенной системе. Вот. И почему более современная не может примениться. С этой точки зрения просто интересно познакомиться с тем, какие есть виды атак. Ну, например, так-так-так. Вот. Один из интересных видов защиты, который здесь появился новый, это Reverse Map Table. Это механизм, который защищает доступ в память. То есть до этого SNP если гипервизор записал что-то новое в память, то виртуальная машина не могла понять, это она записала сама или это гипервизор записал. Теоретически гипервизор не знает ключа шифрования, поэтому он мог записать мусор и фактически остановить работу виртуальной машины. Вот. Но иногда он мог, например, считать предыдущее значение, а потом через какое-то время повторить это значение. При том, что если он знает, чем именно занята виртуальная машина, это могло даже как-то быть на руку злоумышленником. Ну, то есть вы записываете информацию, которую вы знали, что там в прошлом что-то случилось, и вы после этого момента начинаете проигрывать заново то, что в памяти было записано. Ну, какие-нибудь подобные виды атак. Вот. И для того, чтобы защититься от подобных видов атак, когда гипервизор или кто-то другой или другая виртуальная машина может записать в память какую-то даже не работающую информацию, вот как раз вот этот Reverse Map Table RMP, он работает. Она работает с помощью большой поддержки на уровне Hardware. То есть вводятся дополнительные биты и состояние памяти. Каждая страничка памяти может сейчас иметь 8 разных состояний. Вот. Между этими состояниями есть здесь прям специальная таблица переходов, кто каким образом может перевести память из одного состояния в другое. Ну, скажем, например, когда виртуальная машина новая стартует, то гипервизор выделяет себе память, гипервизор выделяет эту память и присваивает ей состояние Invalid, Guest Invalid. Invalid, прошу прощения. Но идея в том, что он не может поставить никаких состояний, которые будут считаться рабочими с точки зрения виртуальной машины. То есть он ставит состояние, которое говорит, что неправильное состояние, но гость может начать пользоваться, начиная с этого состояния. И гость уже, имея это состояние, переводит его в рабочее состояние уже изнутри себя, минуя гипервизор с помощью поддержки с процессора. То есть виртуальная машина может сделать какие-то изменения в состоянии, которые гипервизор сделать не может. Вот. После этого она должна как бы начать работать с этой памятью. При этом, если любая другая виртуальная машина попытается записать что-то в данную страничку или гипервизор попытается записать что-то в данную страничку, то оно автоматически переходит в другое состояние. Здесь объясняется, как это делается. Здесь есть специальные биты. Здесь специальные таблицы, кто к кому обратился, кто к кому может обращаться. Вот. И соответственно, автоматически и это железом поддерживается и гарантируется, переводится таблица в состояние, которое в дальнейшем виртуальная машина может детектировать как нерабочая. Более того, если она попытается продолжать работать с данной табличкой, автоматически сгенерируется прерывание, которое скажет, типа ты делаешь какую-то фигню, перестань это делать. Вот. На самом деле очень интересная концепция. Я подобную сложность системы даже не ожидал здесь увидеть. Я когда до этого работал с Эльбрусами, там была другая друэтика в защиту, другие интересные методики, но вот подобные мне прям зацепило тем, насколько глубоко надо было все это интегрировать во все части системы. Вот. И насколько это надо было сильно все придумать. Я боюсь даже себе представить. На самом деле все очень сильно завязано на шифрование. То есть, вот этот ключ шифрования, который выделяется в виртуальной машине при ее создании, мы с помощью него зашифровываем мета-информацию. Мы можем потом проверять, что именно мы зашифровали, и правильно информация была зашифрована, и так далее. То есть сейчас на уровне процессора куча именно процессора в процессоре прошито, создание виртуальной машины. Мы тут начинаем работать с памятью, а давайте мы мета-информацию засунивать в этот кусок памяти, а давайте мы то, что мы засовываем, зашифруем, а потом можем проверить, что мы все правильно сделали, никто не расшифровывать, никто другой чужой не подсовывал. Очень-очень интересно. Есть, более того, если честно меня вот удивляет глубина, я не знаю для чего они это добавляют, они наверно, у них есть большие планы того, что с этим можно дальше делать, пока у меня только частично есть понимание, что они делают. Есть уровень привилегии виртуальных машин, то есть внутри ваших виртуальных машин, то есть я подумал так, вот вы запускаете виртуальную машину и вы теоретически внутри себя, как бы, к вам никто не может в память записать, вы никому не можете в память записать, вы защищены, делаете, что хотите, вы можете запустить свою операционную систему, и она начинает работать, как есть. Оказывается, что все не так просто, скажем, я чуть подальше поговорю про прерывания, а сейчас внутри вашей операционной системы может понадобиться, что у вас было несколько уровней привилегии для доступа к памяти, и по умолчанию, когда запускается виртуальная машина, она запускается с нулевым уровнем привилегии в MPL 0, вот так она называется, сейчас я ее расшифрую, Virtual Machine Privilege Level, да. Соответственно, нулевой уровень имеет полный доступ на все, и он может раздавать другим доступом, другим уровнем доступа в какие-то части памяти. Скажем, он может сказать, так, вот эта страничка будет читаться и писаться только первым, но не запускаться уровнем. Вот эти странички, они шаренные для всех, все могут писать и читать, а вот подобные уровни доступа, уже нулевой уровень, может делать всем внутри именно данной виртуальной машины. То есть вы понимаете, что где-то уровнем выше есть гипервизор, где-то уровнем выше есть настоящий процессор, то есть у вас же не просто процессор, у вас виртуальный процессор внутри, он работает где-то на настоящем процессоре, и внутри этого виртуального процессора есть сколько уровней? Четыре уровня доступа привилегий. Ну для меня это просто взрыв мозга, и когда начинаю мыслить такими категориями, у меня, я не знаю, не всегда это могу сообразить, надо кофе побольше наливать. Понятное дело, что прямо сейчас на рабочих станциях это никому не нужно, это нужно только для того, чтобы запускать в Cloud где-то большие сложные вычисления, которые вы хотите сделать безопасными. Но вот количество работы для того, чтобы захватить кусок Cloud для меня кажется прям чересчур огромным. А, кстати, хотел сказать, что даже white paper начинается с того, что ребята у нас тут мы вот начали делать работу с изоляциями, вот этот первый уровень изоляции СЕВ, который мы ввели, он был достаточно неплохой, все оценили, и все хорошо, но, в общем, это не очень вау, но мы подумали, что многие рынки смогут оценить вот это вот дополнительные уровни защиты виртуальных машин друг от дружки, и, в общем, вопрос в white paper технической статье, фактически, они начали рассуждать на счет того, сколько можно денег заработать, если попытаться сделать более сложную систему виртуализации.",
    "result": {
      "error": "API request failed: Error code: 400 - {'error': 'Trying to keep the first 5796 tokens when context the overflows. However, the model is loaded with context length of only 4096 tokens, which is not enough. Try to load the model with a larger context length, or provide a shorter input'}",
      "stack_trace": "Traceback (most recent call last):\n  File \"/home/andrei/Projects/podcast-shownotes/scripts/build_search_eval_dataset.py\", line 157, in generate_search_query\n    response = await self.client.chat.completions.create(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/andrei/Projects/podcast-shownotes/envs/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py\", line 1927, in create\n    return await self._post(\n           ^^^^^^^^^^^^^^^^^\n  File \"/home/andrei/Projects/podcast-shownotes/envs/lib/python3.12/site-packages/openai/_base_client.py\", line 1767, in post\n    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/andrei/Projects/podcast-shownotes/envs/lib/python3.12/site-packages/openai/_base_client.py\", line 1461, in request\n    return await self._request(\n           ^^^^^^^^^^^^^^^^^^^^\n  File \"/home/andrei/Projects/podcast-shownotes/envs/lib/python3.12/site-packages/openai/_base_client.py\", line 1562, in _request\n    raise self._make_status_error_from_response(err.response) from None\nopenai.BadRequestError: Error code: 400 - {'error': 'Trying to keep the first 5796 tokens when context the overflows. However, the model is loaded with context length of only 4096 tokens, which is not enough. Try to load the model with a larger context length, or provide a shorter input'}\n"
    }
  }
]