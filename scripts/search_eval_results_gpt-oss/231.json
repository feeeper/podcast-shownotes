[
  {
    "segment_id": "68a98452-f8ec-4ee0-9309-bfac3af6a617",
    "episode_id": "f97d17d5-6496-44d5-8c9c-6a10ec7e088c",
    "episode_number": 231,
    "segment_number": 3,
    "text": "То есть у них свой агент называется Promtail, у них своё хранилище, вот собственно локи. И у них вообще очень много они философии позаимствовали из Prometheus, и в целом подходы очень хорошие, ну очень похожие, и они мне нравятся в каком смысле. И я попробовал, у меня возникли некоторые сложности, там изначально с клиентом, официальным клиентом к локесу, ну точнее к Promtail, потому что как бы запись происходит через агента. Пришлось написать свой клиент, к счастью у них простой протокол о том, как я его там написал и как им пользоваться, я в бложике постил буквально на этой неделе, и по той причине, что собственно зарелизилась графа на 6.0, и теперь это стейбл, они больше не будут API менять, всякое такое. Лёш. Можно я маленькую ремарочку сделаю? Давай. А то у меня вопрос, Лёша. Да-да, во-первых, я хотел сразу узнать, поддерживает ли Thanos, который, мы рассказывали как-то про Thanos в одном из выпусков, что Thanos позволяет строить, как это, high availability Promtail серверов, там мастер-мастер аппликейшн, вот это всё, то есть как бы это не чистый мастер-мастер, это Thanos позволяет строить такое. И поддерживает ли он Локи. И я полез в интернет посмотреть, как бы поддерживает ли нет, ну и конечно же простейший мой запрос, который я обычно делаю, Thanos, Локи, support. Вот, ну и я попал на кучу видео, картинок и прочего аниме, видно, что такое Thanos, что такое Локи, как они между собой взаимодействуют. Я думаю, ну как же мне лучше-то, ну и добавил туда Prometheus, в общем, лучше не стало. Я в общем даже не знаю, как искать. Ну на странице Thanos нет ничего про support Локи пока что, но я думаю, что они его поддержат. Подожди, то есть верно ли я помню, что Thanos это как Prometheus, только распределённый? Да, Thanos это надстройка следующего, добавление ещё одного уровня абстракции, это сервер, который работает с кучей Prometheus, фактически создавая их шардами с репликациями. Хорошо, а что, ну допустим в нём есть поддержка Локи, а что ты от этой поддержки хочешь? Ну в смысле ты пишешь метрики в распределённый storage, и ты в этом распределённом storage хочешь поддержку системы для агрегации логов. Вот я пытаюсь понять, что ты от неё хочешь, от этой поддержки. Thanos удобен тем, что он вообще всё делает из коробки, то есть он говорит, слушай, покажи мне список установленных Prometheus, я их настрою так, чтобы они работали подо мной правильно и корректно, понимаешь, да? То есть как бы если он поддерживает Локи в таком же ключе, это очень удобно, потому что ну логов обычно очень много, и ты хочешь, чтобы был быстрый доступ к ним, особенно если много пользователей, и шардирование из коробки с репликацией это прям удобная фича. А, я понял, ты имеешь в виду как средства для шардирования или чего-то такого для Локи, да? Да, да. Ага. Я кстати, ну я не могу сказать, что я прям глубоко познал Локи, может быть в нём есть какое-то шардирование всё-таки, но если они полностью следовали идеологии Prometheus, то конечно этого нет. Ну вообще вот связка Thanos-Prometheus, она очень удобна, и хотелось бы конечно, чтобы Локи из коробки мог работать с Thanos, то есть идея в чём, потому что когда ты работаешь с Thanos, ты говоришь всем, кому ты говоришь, что как бы вот мой Prometheus сервер это вон, а это на самом деле входная точка Thanos. И если ты работаешь с Локи через эту же точку, то Thanos должен поддерживать работу с Локи, хотя бы просто пропуская сквозь себя до установленного Локи где-то. У тебя нет единой точки входа к одному из Prometheus, когда ты работаешь с Thanos, он всегда через себя пропускает весь поток. А расскажите про клиентское взаимодействие, то есть вы с кого-то сошёпаны, ну что есть клиент, а с точки зрения кода, как это там для библиотеки, для разных языков, что там? У Локи, точнее у ПромТейла, у агента для Локи, у него очень простой протокол, это, кстати, в отличие от Prometheus, push-протокол, то есть туда надо пушать логи, а не, ну Prometheus, он наоборот, пулит с серверов. И протокола два, один основан на JSON, второй на Protobuf, и тебе просто нужно документ отправить в определенном формате или структуру протобуфскую, ну как бы в определенной HTTP конец и всё. То есть там магии особой нет. Самая большая проблема у меня возникла, что у них есть понятие source, типа источник твоих логов, и довольно неочевидно, что он должен быть уникальным для каждого даже экземпляра твоего приложения. То есть, например, у тебя два микросервиса одинаковых, но они на двух хостах, вот source должен быть разным, иначе ты получаешь ошибку, что первый микросервис отправляет логи в логи, и как бы он говорит, окей, всё принято, записано, а второй микросервис отправляет логи в логи и получает ошибку, что, чувак, по этому source, короче, таймстемпы идут не по порядку, и я твой запрос реджепчу. Вот, поэтому sources должны быть разные, тогда всё хорошо у них собирается. Вот, собственно, у меня был вопрос к Алексею. Лёш, а чем, ну как бы вот когда ты его порекомендовал, я так полагаю, у тебя был некий опыт уже, и тебя что-то в нём зацепило, вот ты не мог бы это подробнее рассказать? Нет, на тот момент у меня опыта почти не было, у меня, на самом деле, может быть, даже прежде, чем ответить на этот вопрос, вернусь на два шага назад, когда мы обсуждали TANOS и Prometheus, мне кажется, там слишком много путаницы мы нанесли нашим слушателям, как бы так сказать. Локи — это штука, не связанная с Prometheus сейчас почти никак, то есть она под впечатлением Prometheus сделана, но независимо, то есть изначально Локи делался... ладно, давайте ещё на шаг назад. Есть такой Том Вилки, сейчас это VP of Product Graphane, до этого он работал там в нескольких проектах, он делал проект, который назывался Cortex. Cortex — это ещё один испределённый Prometheus, как вот TANOS, можно сказать, победил, сейчас многие люди работают с TANOS, есть ещё Uber, M3, вот, на ним тоже много контридеров работает Cortex, немножко более-менее сдувается. Идея была в том, что брать эти Локи, метки какие складывать на С3, и дальше, соответственно, по запросу их скачивать, делать запросы и удалять этот локальный кэш, в общем, большое хранилище внешнее для Prometheus, которое хранит данные в S3, при этом это был не Remote Read, не Remote Write, это вот именно форк кодовой базы Prometheus. Дальше этот форк сильно-сильно менялся, потом в какой-то момент они поняли, что вообще говоря, это хранилище, в S3 оно медленное, оно не очень хорошо подходит для метрик, которые, как правило, более легковесные, с ними нужно работать быстро, но оно хорошо подходит для логов. И по сути кодовая база Локи началась вот примерно с этого, когда они решили, окей, у нас есть исходный код Prometheus, там много всякого хорошего, сервис Discovery, например, но при этом это все хорошее, довольно глубоко интегрировано, давайте мы кодовую базу Prometheus разделим на несколько частей, при этом не будем пытаться это контрибьюить обратно в Prometheus, потому что они не очень хорошо принимают такие большие рефакторы, их тоже можно понять. Вот, они выдрали из него кусок там сервис Discovery, в частности, выдрали из него хранилище сильное, и в итоге теперь Локи практически никак от Prometheus не зависит, за исключением, может быть, некой общей идеи, философии и так далее. Соответственно, Локи хранит данные, по умолчанию хранит в локальном хранилище, которое очень похоже на TSDB Prometheus, но может также хранить там в S3, в Google Cloud Storage и так далее. Он распределен, он может быть распределенный, опять же, по примеру, даже не та на своем кортексе, как он был до этого. Вот, соответственно, какой у меня опыт, я говорил, у меня опыта толком никакого нет, я просто знал эту всю историю немного изнутри, потому что я смотрел и общался с Томом на GraphanaCon, не на GraphanaCon, на PromCon полтора года назад, когда там вообще тема распределенных сториджей, удаленных сториджей для Prometheus была очень горячей, и он тогда еще кортек сдвигал. А потом в итоге его стартап, по сути, Graphana купила, и вот они начали это все проделывать. Подожди, подожди, но то есть они все-таки сейчас внутри Graphana Labs? Сейчас локи делаются внутри Graphana Labs, и Том теперь работает в Graphana, он там VP продукта. Ну, продукт, собственно, это локи. Да, то есть мой пойнт такой, что, во-первых, это сейчас почти никак не связано с Prometheus, это связано, честно, с Graphana, и, соответственно, они плюс еще хотят добавить в Graphana поддержку просмотра логов не только из локи. И даже если она сейчас не очень хорошо работает, то у этого решения, наверное, одно из самых больших будущих, потому что у них есть компания, которая стоит, есть деньги и все такое. Кстати, во-первых, про связь с Prometheus, а во-вторых, момент, который, возможно, мы плохо подчеркнули, то есть в Graphana теперь есть не только метрики, но и логи, и по дефолту они как бы берутся из локи, но вот то, что Леша озвучил, что планируется поддержка и других стороджей, наверное. И довольно удобно иметь в одном месте, то есть в Graphana и метрики, и логи, и, насколько я понимаю, там есть еще и...",
    "result": {
      "query": "Thanos Loki support high availability"
    }
  }
]