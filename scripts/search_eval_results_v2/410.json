[
  {
    "segment_id": "8a7dc162-918a-4336-b0a7-0b708eeed785",
    "episode_id": "7b5d2f9c-b21c-4570-a5ad-42f3929c933d",
    "episode_number": 410,
    "segment_number": 5,
    "text": "Я желаю, чтобы это жило и развивалось, и я пока не использовал асинхронный раз в продакшене, но, возможно, это изменится, и к тому моменту, как это изменится, я очень надеюсь, что этот статут лап будет хотя бы типа, не знаю, версии 0.9, потому что сейчас на версии 0.3. Такие дела. А поскольку никто больше не испытывает из ведущих энтузиазм по поводу Rasta, я возьму другую тему по поводу, которую ведущие в прошлый выпуск не испытывали энтузиазмы. Я им оптимистичен. Возможно, тебе стоит объяснить, почему мы должны испытывать энтузиазм. Да, я так и сделаю. В прошлый выпуск слушатели принесли тему, которая называлась Future Proofing our Metadata Stack with Panda от Escalable K-value Store от компании Dropbox. Ребята ее постарались как-то обсудить, но не успели прочитать, а я-то как раз летел в самолете, у меня было время прочитать, у меня не было в подкасте, увы. В общем, я, наверное, не буду совсем заново пересказывать все, что... Я уже и не помню все, что в прошлом выпуске обсудили, но, наверное, нужно сформулировать задачу, которую решали ребята из Dropbox. В общем, такое ощущение, что она была недопонята. У них не было цели сделать с нуля транзакционную базу данных. Я тоже когда-то открыл страницу такой типа хаха, лол, ребята, вы чё. У них есть две системы распределенные Edge Store и File System. Они обе построены на кластерах MySQL, которые как-то крутятся, мутятся, с руками, шардируются, и там есть проблемки. В частности, что у них шардирование существующее, оно умеет только увеличивать или уменьшать кластер... даже, по-моему, уменьшать кластер вообще не умеет, но умеет только увеличивать кластер в два раза. И они приближаются к тому моменту, когда им нужно увеличить кластер за два раза, будет скоро снова, и им это будет очень дорого делать, потому что он так уже очень большой, и главное не нужно. Поэтому самая главная проблема, которую они решали, это возможность... это будет какая-то система, которая будет уметь решардить MySQL маленькими порциями. Это прям вот самая главная проблема, которую они решали. Вторая проблема, которая у них есть. У них есть, собственно, две системы Edge Store и File System. Ни одна из них на самом деле не использует всю мощь MySQL. Они на самом деле используют это всё примерно как KeyValue. И во-вторых, у нас есть две системы, которые делают примерно одно и то же. У каждой из своих чуть-чуть кастомных кластер MySQL, у которого какие-то чуть-чуть кастомные способы это оперировать. Опять же, хотелось бы им взять и иметь общий способ вот этим всем манипулировать общую опишку, и чтобы на это как-нибудь по идеали бы съехать, не выбрасывая... без какого-то особого выбрасывания, переписывания того, что есть. И они как-то писать свою собственную штуку, это не первое, за что они схватились. Они посмотрели на FoundationDB, на VTS и на Cockroach. С FoundationDB у них претензия такая, что там... мы как-то рассуждали артихтуру FoundationDB в одном из подкастов, я не хочу всё это опять же пытаться пересказать заново. Смысл такой, что там есть некоторые потенциально узкие места, и FoundationDB на данный момент тестируется на кластерах порядка 500 процессорных ядер. И оно вот на этой нырурске работает. Никто никогда особо не пытался отмаштабировать на ныробоксовские масштабы, что примерно на 10 тысяч ядер. И они сами как-то что-то попробовали и обнаружили, что там есть реально затыки, которые просто... сколько ты машин не брось на FoundationDB, оно дальше лучше не поедет. И им не очень хотелось... это выглядит как какие-то артихтурные проблемы для них сейчас, для дропбокса. И они достаточно глубоко в FoundationDB погружены, чтобы это чинить. VTS это система шартирования MySQL, которая родом из YouTube. Она open-source, поверх неё, если не ошибаюсь, построен проект Planescale. Мы его тоже в подкасте обсуждали. И VTS их не устроила себя правильно помнить тем, что у них транзакции ограничены одним шардом. Дропбоксу, несмотря на то, что им достаточно key-value в плане интерфейса, им хочется крошат транзакции. Также им не понравился, как устроен решардинг в VTS. Я там уже не помню деталей, но в общем не понравилось, как именно он работает. Там гарантия для них недостаточной дает. Крош, DB наименее обоснованные претензии, на мой взгляд. То есть там выглядит так, что оно почти более-менее подходит, но дропбоксу типа хочется... у него наоборот слишком хорошие гарантии, получается, с точки зрения дропбокса. Из-за этого высоковатое latency. То есть дропбокс использует репликацию, которая называется Semisync в MySQL. Если я правильно понимаю, это означает, что если... во всяком случае между дата-центрами они используют Semisync. И это значит, что если дата-центр упадет, какие-то записи, которые в том дата-центре произошли, которые упал, они могут не доехать. Что, ну, на мой взгляд, то такое. Но зато дает им очень хороший маленький короткий latency. Кокровище-видетели дают прям совсем-совсем-совсем жесткие гарантии, и у них latency не там не 5 мс, а 80 мс в среднем между регионами. В общем, это была главная претензия к Кокровище, и что это никак нельзя потюнить. Может быть, можно, но не так, как хочется дропбоксу. Вторая претензия к Кокровище, что никто его не тестировал на таких масштабах, как у нас. Ну, ребят, мало какие системы существующие в open-source тестируются на ваших масштабах. В общем, в целом, кокровище-сокровища такое, что, ну, может быть, через 5-10 лет наша панда съедет на Кокровище под низом. Что такое панда? Это, по сути, набор обвязок вокруг MySQL, которые разделяются параллелем, соединяются в кластер. Какие-то штуки занимаются тем, чтобы предоставлять frontend interface и роутить запросы, делать транзакции. Какие-то штуки занимаются тем, чтобы репликацию настраивать и так далее. Не буду в детали влезать, там, в принципе, ничего особо, как это, ground-breaking нет. Из интересных идей, которые мне понравились, это частичные ответы. То есть, идея такая, что для очень многих нагрузок мы можем дать полный ответ, скажем, за секунду или даже три секунды, потому что нас какой-то один шарт затупил, или можем не дожидаться, ответить, что есть и сказать, ну, это не все на самом деле, но дорогой frontend начинай рендерить, как есть. Или там не frontend, а что, там приложение. Еще что-то, какой-то другой сервис. Вот те данные, которые есть сейчас и не пытаться дожидаться, пока он там раздуплится. Это очень клевая идея, мне она очень нравится. Я бы такое где-нибудь сделал. Это позволяет делать как-то предсказуемый ответ и высок шанс, что пользователи вообще не докрутят до того места, где у них данных нет. И просто никогда их не придется запрашивать и ждать там эти три секунды. Вот. Я, в принципе, желаю ребятам удачи. Я согласен, что выводы, которые они сделали, они довольно тривиальные, как ребята обсудили в прошлом выпуске. То есть, типа, всего есть трейдов, здорово. Предоставляете наиболее, как это, наиболее слабую работающую грандью, ну, здорово. То есть, в принципе, все эти вещи мы так слышим, знаем. Я надеюсь, что, как бы, почитав статью, я понимаю, что у них не настолько амбициозная цель, как сделать там базу данных с нуля, у них скорее как-то сделать аккуратную обертку задачу. И они, в принципе, собираются заниматься рандомизированным тестированием. И выглядит так, что все должно получиться. Но я сам один из тех людей, который хранит данные в toolbox, и я надеюсь, что они не будут это слишком быстро и агрессивно раскатывать. Как-то так, если очень кратко. Да, еще из того, что мне упоминалось, они еще рассматривают съезд на ROXDB с MySQL, но это типа опционально, потому что, в принципе, сейчас все в MySQL и конкретно как storage, он их более-менее устраивает. Такие дела. Я, может быть, ответил на какие-то вопросики, которые были у Саши с Ваней в прошлом выпуске. И ответил и пришел к тем же выводам. Спасибо тебе. Спасибо, пояснил. Нет, ну, выводы у меня не совсем те же самые, потому что вы там начали как-то набраться, что кто-то там очень хотел промоушен получить, начали делать новую систему. Ну, я не уверен, что все. То есть у них там реальная проблема была. Я с такой проблемой тоже сталкивался. То есть, что... И потом это очень интересно решали. Мы с вами обсуждали блокпост от кажется ноушена, как они шардировали посгрез. И они там выбрали очень интересную схему шардирования. Они не в два раза увеличивали. Они там то ли числами фиби начи, то ли еще какую-то последовательность выбрали. Так, как раз, чтобы вот эта проблема с удвоением не возникала. То есть, ты выбираешь не... У тебя следующее разбиение, оно не в два раза больше получается. Там сколько-то процентов больше получается. То есть, на самом деле есть статические способы решардить. Но они, видимо, как-то давно сделали этот выбор увеличивать так в два раза. И их текущая схема шардирования по-другому просто не может. Вот. Ну да, я желаю им удачи. От этого зависит целость моих данных в частности. Я хотел бы уточнить. Под решардингом ты имеешь в виду увеличение количества шардов. В том смысле, что минимальная единица... То есть, один шард это вот минимальная единица, которая может жить на одной машине. Я, если честно, не помню, как у них... Я все-таки читал статью уже, считай, почти больше недели назад. Я не помню точно, как что они называют шардом, что типа инстанцем. Но в общем, общая ситуация такая, что они могут только увеличить количество машин в два раза в текущей системе. А на самом деле у них нагрузка выросла не в два раза, а на сколько процентов. Я понял. Просто есть партизирование, есть шардинг. И разные люди называют немножко разные вещи. Речь про распределение данных по машинам физическим. Я понял, что они на ранних этапах проекта сделали некоторые дизайнерские решения, которые казались неудачным. Но я хочу сказать... Как неудачным? Оно с ними жило больше 10 лет, я думаю. И было норм. Я хочу сказать, что для решения этой проблемы тебе не обязательно нужны числа Фибоначчи. Я числа Фибоначчи с потолка взял, если честно. Я не уверен, что там были числа Фибоначчи. Там просто был какой-то такой делитель по модулю, там не было никаких чисел Фибоначчи, я надобрал, который бы позволял, типа, решарникам по модулю не в два раза увеличивать, а, типа, такими интересными, в общем, кусками. Нет, я имею в виду, тебе вообще надо вот эти хитровыдуманные схемы со специальными простыми числами или чем-то они не нужны для нормального масштабирования в сколько-годно долгой перспективе без удвоенчесла машин. В смысле не нужны? Ну, прямому. А зачем они тебя? В смысле, если у тебя данные не влезут в одну машину? Если у тебя данные не влезут в одну машину, ну давай, смотри, хорошо. У тебя есть... блин, я сейчас слишком сомнен, чтобы... Понимаешь, в чем же прикол? У них же не так, что у каждого пользователя свой маисикл. У тебя, скорее всего, на одном физической машине сидят там больше одного пользователя, но некоторые пользователи не равны. Есть некоторые пользователи, которых потребление сильно выше, чем у других, и хочется нагрузку распределять по физическим машинам более-менее равномерно. И неравномерное потребление это и по цепу неравномерное может быть, и по диску может быть неравномерное, поэтому ты хочешь на самом деле вот части key space, которые горячие, иметь... там, не знаю, ты под условием маленькую часть key space, которая горячая, можешь иметь... можешь хотеть иметь машину по жирности такую же, как машину под, не знаю, гораздо меньше... гораздо больше объемки space, но где менее горячие данные лежат. Я для заинтересованных слушателей скинул в чатик ссылку на блокпост, который я написал в 2016 году. Мне сегодня очень сильно хочется спать, поэтому я не смогу его пересказать. Вот, там описано различия между шарзигом и передбалансировкой. Это не вообще принятая терминология, но та, которую я часто встречал в официальной документации в других источниках, и описано, как без чисел фибоначей и всяких других приколов сделать нормальное масштабирование, которое решает проблемы, которые Валера озвучил. Не, ну подожди, ты там это делаешь через V-бакеты. У тебя все равно, у тебя есть фиксированное количество V-бакетов все равно. А вот оно не фиксированное. Количество V-бакетов ты можешь удваиваться или делить на 2, но когда ты это делаешь, ты не удваиваешь количество машин. А знаешь, с чем еще это, я сейчас смотрю просто на твой подход, чем еще им принципиально не подходит это решение. У тебя кикспейс разбивается на, типа вот, собственно, бакеты. Они не хотят бакетить кикспейс, у них плоский кикспейс. И они хотят его в рандомных местах резать, или что они хотят. Но, мне кажется, нет особой проблемы с этим. С хэшированием? Это хэшируешь, и есть с этим проблема, потому что у тебя при хэшировании оно указывается где угодно. Смотри, схема шардирования, она не... то есть здесь в статье там предлагается использовать хэш, но это как пример. Ты можешь сказать, что вот начать с одного огромного бакета, который включает все ключи. Потом разделить его на два. Сказать, что у меня вот здесь делитель, и у тебя в мета информации написано, что вот у меня в первом бакете от нуля до какого-то значения, в втором бакете с этого значения до бесконечности. Ну, у них есть для этого специальный сервис метаданами, который вот это задает. Хорошо, но прикол в том, что когда ты создал, вот ты, допустим, поделил этот бакет, у тебя был один бакет, ты создал новую информацию, которая говорит, что у тебя два бакета, и у тебя оба бакета указывают в одну машину. У тебя количество машин не удвоилось. Потом ты делаешь перебалансировку. Это не то же самое, что и решит шардинг. Ну, если ты почитаешь статью, они примерно к тому же самому и приходят. Ну, то есть типа они в начале, значит, изменяют... Ну, то есть, я не помню, у них есть... то есть, например, range transfer, это у них называется секция, они там тоже описывают, как они делают range transfer. То есть, да, если я правильно понимаю, они тоже в начале range... как-то у них есть и проблема того, что им нужно range переразбивать, и проблема того, что некоторые range, которые стали горячими, нужно уносить на другие машины. Но я не думаю, что ваше решение... то есть, у тебя все равно, когда тебе понадобились новые физические мощности, как-то не имплементируй нарезку, у тебя есть этот процесс перенести данные с машины А на машину B. Смысл в том, что у тебя задача, сложная большая задача по созданию горизонтального масштабированной системы декомпозируется. На многом они не значат. Ну, они описывают... У тебя отдельно resharding, то есть изменение схемы шардирования отдельно, перебалансировка, то есть перемещение физических данных с машины на другое количество машин. И, ну, если Dropbox пришел к этому решению... У них не совсем такое сомнение, у них там тоже есть... у них там тоже описано, короче, вот типа по шагам какие действия происходят. Ну, понятно, в вариации массы, да. Вот, ну, то есть, они же не такие же... то есть, это не какой-то принципиально новый супер-пупер кейвейли-стор, который у него у кого нет. Это именно, что абстракция, которая занимается... берет на себя функции, которые вот они хотят, чтобы между двумя системами одинаково работали, и, ну, их не устраивает Да-да, я понимаю. Я не говорю, что они что-то неправильно сделали, или что в задачи построить горизонтальную масштабируемую систему там за последние 5 лет были какие-то глубокие откровения, мне просто резонул слух... Я тебя так услышал, возможно, ты не это имел в виду, что там без хитрых математических приколов типа там, каких-то, скажем, простых чисел нельзя решить задачу решарзинга. Не-не-не, это про другое. Я добавил статью в карточку. Это было про другое, что у них конкретный дробокс, они взяли изначально план, ну, просто как бы сделали систему увеличения на два. Это работающая схема, но она с каждым увеличением на два становится дороже и дороже и дороже и дороже, особенности нагрузка больше не растут экспоненциально. Есть другая схема, которая... Я не помню, что там за числа используется. Так, вот тут я, кажется, нашел статью. Я не знаю, что это за последовательство, но она такая 2, 3, 4, 5, 6, 8, 10, 12, 15, 16 и так далее. То есть это все делится на какой-то... Там какие-то красивые делители. Я хотел пошутить, что это числа Каталана. Каталана? Я не знаю таких чисел. Это было в Дебзене. Это как у тебя растет сложность от количества джойнов. Окей, вот, извините, забыл как это название термина из-под одной из предыдущих Дебзенов. Ну да, это, по-моему, было недавно даже. И там прикол в том, что вот эти... 480 шардов и 480 — это магическое число, которое делится на 2, 3, 4, 5, 6, 8, 10, 12 и так далее. То есть минус в том, что 480 шардов, ну, вырасти потом 480 дальше будет проблема, но зато перебалансировка эти 480, их можно перебалансировать очень большим количеством способов. В принципе, дробокс тоже могли бы выбрать какую-нибудь такую прикольную схему, когда перебалансировать. .. То есть вы в самом начале нарезаете на шарды, а потом просто балансируете до бесконечности. Но все равно это решение упрется в то, какое число шардов вы в самом начале выбрали. Ну да, ну да. Мое глубокое убеждение, без претензий на знание объектной действительности, ну вот, если я с нуля делал горизонтально мастерибируемую систему, вот подходы, где у тебя сложная задача, несколько сложных задач мешаются в одну вместо того, чтобы декомпозировать, такие подходы, они рано или поздно обречены на провал. Ну просто другой вопрос, что через 10 лет, возможно, это будет не ваша голодная боль? Нет, так я с этим утверждением вообще не спорю, потому что все крупные расплетные системы, они так и сделаны, в общем-то. То есть тот же самый райк был так сделан, тот же самый, не знаю, как рощ, мне кажется, похоже, можно сделать. Бывают неделимые вещи, типа, не знаю, какой-нибудь рафта, то есть нельзя сделать кусочек рафта и назвать это рафтом, но именно все операционные истории... Я помню, в райке была такая система, где накапливались такие административные команды в специальной очереди, которая госипилась между узлами, когда все узлы согласились, что вот так вот у нас начало очереди выглядит, они начинали это постепенно выполнять. И как бы изменения кластера, как раз, накапливались в этом буфе административных команд, именно чтобы не делать одну большую и сложную операцию, а выполнить такую последовательность более простых действий. Так что это в принципе тоже ничего нового, но да, это полезный совет. Ладно, я думаю, можно с этой темой заканчивать, мы уже два выпуска обсуждаем. Я отдам слова Саше, у него хорошие базюльки. Значит, хорошая долгоживущая тема. А что еще долгоживущая тема, которая у меня в интерфейсе Трелл аж раздвоилась? Это протоколы рекавери в базах данных из курса Advanced Database Systems, который читает Энди Павло.",
    "result": {
      "query": "Dropbox metadata stack sharding"
    }
  }
]