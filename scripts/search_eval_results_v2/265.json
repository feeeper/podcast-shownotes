[
  {
    "segment_id": "f5be57cb-c674-471b-a0c1-2e9caafe69c3",
    "episode_id": "469de9c0-85ba-4724-a221-4e8ece76a4c5",
    "episode_number": 265,
    "segment_number": 8,
    "text": "А, ну окей, я как-то безграмотный дворянин, и не суфю к нему, я прошу прощения. Вот, возвращаясь к Timescale, да, это Postgres расширенный до состояния Time Series без данных, то есть ребята, если правильно помню, у них там основная идея в самой базе была в том, чтобы Postgres хип нарезать на такие группы строк, если я правильно помню, которые бы там рядышком лежали по какому-то принципу, и, то есть, чтобы не запрашивать всю таблицу за раз, а только те куски, которые точно будут участвовать в запросе. Но при этом на диске оно все еще раньше хранилось, как обычный Postgres хип, то есть это довольно недешево на самом деле, потому что, если вы не в курсе, что это вообще Postgres хип, у вас, во-первых, это строчно ориентированный формат в целом, то есть если у вас широкие строки, у вас уже могут быть, может быть, не очень клевые по производительности, просто потому что вы будете поднимать с диска полные строки, а не какие-то нужные вам вещи, там, не знаю, скажем, если у вас такие 20 колонок, вам из них нужен timestamp и device type, скажем, и допустим, какой-то один из параметров, одной из измерений, то все остальные колонки поднимать вам, может, не хотятся, их может быть много, они могут много места занимать, а вы их все равно поднимете. Это проблема номер один. Вторая проблема связана с тем, что если у вас есть какая-то колонка типа timestamp, которая на самом деле очень последовательная, она очень хорошо жмется, в ней очень как бы, ну, как там... Скорее всего, данные уже и так хорошо предсортированы и предразбиты, но в Postgres она все еще будет храниться строка по строке, и на каждую строку у вас будет, сколько там, по-моему, 24 или сколько уж не помню, 27, ну или 24 байта оверхеда, да, 27 байта оверхеда на каждую строчку просто, то есть у вас... Подожди, Саш, там 27 байт оверхеда на тупл, да? А не на страницу. 27... Не-не, подожди, чего-то мало. Ну, Postgres'овый оверхед, он пер-тупл, а не пер-пейдж, я вот такое спрашиваю. А-а-а, слушай, я забыл. Ну, короче, ну тут пишут, что 27 байт на строку — это оверхед. В общем, ну, ребята почесали репу и подумали, что ну как бы вообще, как бы есть параллельный мир, где люди хранят данные в колоночных форматах, например, там, не знаю, в паркете или еще в чем-нибудь таком, и у них очень клево все жмется, у них, там, не знаю, можно не читать колонки, которые не нужны, и оверхед на... То есть там, не знаю, получается даже, что там в принципе при хорошей конкопляции можно сильно меньше, чем по байту на значение иметь, даже если значение как бы довольно длинное, типа timestamp'а, просто они у вас, поскольку один за другим, то все прекрасно жмется. Но с вещами типа паркета есть проблемы, связанные с тем, что его нужно накапливать, чтобы писать, а там, не знаю, timeseries обычно приходят по одному измерению, то есть нужно что-то как-то думать, делать, ну и вообще им хотелось продолжить по возможности работать с... Как бы попробовать как бы сгореться, а не делать какие-то совсем уж посторонние решения. Поэтому они сделали следующую вещь. Они запихали как бы данные, допустим, тысячи строк в один тупл. Это не совсем новая идея, я точно помню, что похоже, расширение для пасгреса с названием Vops, по-моему, Константин Книжник его показывал на, по-моему, даже позапрошлогоднем, или на прошлогоднем PgCon в Мураше, в Москве, по-моему, даже позапрошлогоднем. Но здесь радикальное отличие в том, что в отличие от Vops, где нужно было специальными функциями все это трогать, здесь оно себя ведет похоже, что максимально прозрачно с точки зрения наружной базы данных. И еще прикольно, что они, понимая прекрасно, что если мы вот так вот данные сгруппируем, то нам станет сложно это индексировать и запрашивать, они автоматически выводят дополнительные колонки, типа с минимумом и максимумом, если это сортированная колонка. Также они позволяют при создании вот этой вот сжатой таблицы, они позволяют указать, по каким колонкам сортировано и по каким колонкам данные будут группироваться. Таким образом данные, которые лучше сжимать и держать по отдельности, сжимаются и содержатся по отдельности. Плюс у них там явно есть какие-то кастомные ноды для планировщика запросов, поэтому они в курсе этих специальных колонок, которые добавляются, и соответственно оптимизируют в соответствующем образом запросы, видимо, переписывают. Я, возможно, немножко снабрал, потому что, если честно, не до конца уверен, как под сгрифовой планер модифицировать, может, запросы не переписывают. То есть, может, они не планер модифицировали где-то раньше, чтобы запрос переписывали. Может быть, они, наоборот, как раз-таки нода планера слишком умная, фиг знает. Еще одна интересная деталь. У них вставка происходит в старые обычные добрые таблицы по туплам. Просто у них есть background. java, которое периодически перекладывает данные в такие сжатые таблицы. И вот у них пишут, что для некоторых бета-тестеров, которые у них были, то есть, понятно, что не у всех так будет, но для некоторых особо удачливых у них там до 95% эффективности этой компрессии. То есть, ну, выглядит довольно охренительно. Они там приводят математику, то есть, например, ну, не математику, а арифметику. Очень простую. Скажем, у вас 10 терабайт ИБС стоит примерно 12 тысяч долларов в год. Это довольно до жопы. Это, ну, как бы, знаешь, это, конечно, даже не зарплата программиста годовая. Это типа одна, не знаю, в Калифорнии, наверное, одна, как сказать, там, то есть, зарплата 200-300 тысяч, наверное, там типа очень малая доля. Но с другой стороны, так-то, в принципе, это целый сервер на год, наверное. Не очень большой. И если вы там, скажем, сжимаете на 95%, вы вот типа 10 тысяч в год экономите. Это довольно до фига. И по очевидным причинам, опять же, это особенно важно в облаке, где у вас стородж как бы удаленный, а не локальный. Если у вас данные сжаты, то у вас запросы начинают работать быстрее не потому, что у вас там база как-то быстро цифры молотит, просто потому что данные приезжают в базу быстрее. Вот. И там, в принципе, не очень много внимания уделено, но есть табличка по скорости именно выполнения запросов. Сорян, какой-то паттихард снаружи. Единственная проблема, которую они сейчас в своем решении видят, то что после того, как таблица оказывается сжата, с ней никакие insert, update и delete не проходят, потому что данные превращаются в такой рейдон или тыкву, что для большинства time-series нагрузок не звучит как что-то ужасное. И там, не знаю, те use-cases, которые я видел для похожих систем, это вообще... То есть это иногда даже желательное последствие, потому что, опять же, там, не знаю, автовакуум не придет. Вот. Мне кажется, это очень клево. Я бы такой... То есть если бы, не знаю, 2-3 года назад такое решение было, наверное, в моей жизни было сильно проще. Звучит охранительно. Я нашел старые-старые слайды. И да, действительно, размер заголовка у tuple 23 byte, который выравнивается до 24. Если там нету дополнительных флагов типа поля null-не-null, то 24 byte. Я сочту закончил. Можете какие-нибудь свои мысли высказать по этому поводу. Иван, ваши мысли? Ничего не скажу. Я буду молчать, как партизан. Ну то есть партизаны time-series и time-series не хранят. Александр, вы разрабатывали Postgres очень долго. Вы должны, просто обязаны иметь какие-то сокровенные мысли, комментарии. Возможно, вы затаили ненависть на timescale. Возможно, вы затаили на них обратной ненависть и чувство. Может, вы очень хотите взять просто и в порыве любви поинсталировать это решение. Или, может быть, я хочу попытаться все это забыть. Не приходило в голову? Нет. На самом деле, что я могу сказать, Postgres не база данных для хранения time-series. Можно пытаться делать расширения, которые как-то, что-то, куда-то. Но если вы можете использовать, если у вас есть большая потребность хранить именно time-series много, и вы можете это делать не на Postgres, но лучше это делать не на Postgres. Но если у вас большая часть всего-всего на Postgres, и вам нужно немножечко time-series, ну, может быть, это можно делать через расширение. Какие-то такие соображения? Ну, просто timescale, они себя позиционируют просто как супер-мега time-series заточенная база, а не то, что мы Postgres расточили. То, что оно основано на Postgres, это можно узнать только если читать их в девелоперский блок. И, с одной стороны, хочу сказать, а во-вторых, хочу сказать другую еще такую вещь, что я, человек, работавший в компании, где с Postgres делали всякие непотребные вещи, соответственно, заявляю, что Postgres один из лучших планировщиков, который вообще есть на рынке. Postgres довольно медленное выполнение, потому что оно потупловое, но над этим сейчас работают... А, да, мне там еще пишут, что я в Твиттере недавно видел, что Postgres не нужен, потому что скрылает всех ребят, но там был довольно специфичный use case, просто скрытая curiosity была. Вот, Postgres офигенный планер, у него, возможно, не самый быстрый execution, но над этим работают, и по части... То есть, как минимум, делают его... Добавляют жидкость каждым разом все больше и больше. То есть, execution тоже станет быстрее, но оторвать от Postgres, там, грубо говоря, его heap, который не для всего подходит, и приделать к нему какой-то другой формат хранения, дает все еще довольно в целом компетентное решение. Во-первых, потому что у вас с ним будут работать все те вещи, которые разговаривают по протоколу Postgres, то есть, скажем, с тем же самым Clickhouse, с ним еще нужно научиться разговаривать из приложения, и под него еще запросы нужно переписать. Во-вторых, как я уже сказал, у него просто хороший планировщик, то есть, если вам нужно что-то, кроме... Как это? Raw throughput от запроса получить, вам, например, хочется low latency запроса, а не high throughput запроса. Там есть, в отличие от больших... Если у вас большой обмассив данных, вы можете начать быстрый ответ получать, но долго его получать, но при этом вы можете его сцеживать постепенно клиенту, или, не знаю, какую-то стриминг-статистику на нем считать. Или вы можете пойти попить кофе на полчаса, и потом ответить сразу, получить... Для разных визгейсов бывает нужно разное. Вот. Ну, я имею две вещи сказать. Первое, то что они утверждают, что прям баз данных для time-серии. Я просто имею опыт общения с всевозможными пиарчиками, то есть, как бы за свою жизнь с многими общался, и одна из моих любимых цитат – это «Какая еще нахрен честность в пиаре?» Вот. То угодно. Это первое. А второе, что достаточно бессмысленно фантазировать на тему, что хорошо иметь расширение, плохо, для каких задач подходит или нет, потому что случаи на самом деле у всех совершенно разные. И если кому-то для каких-то задач то или иное расширение подходит, ну и отлично. Но ситуации бывают разные. Например, мы тут на проекте столкнулись с тем, что оказывается нам не подходит баджер. И в связи с этим, там, короче, по большому счету, скорее всего, предстоит писать свою базу данных под конкретно свои задачи. Потому что вот в нашем случае универсальная LSM-3 подобная база данных со snapshot calculations, в смысле с сериалайза, был совсем таким, она вот не подошла. Она готовая, она классная, но нам не подошла. Как она вам настолько не подошла, что вот вам не хочется ее форматить, подточить, а хочется прям с нуля начать писать? Мы пишем распределенную систему с шардированием, с репликацией, со всей этой историей. Ничего этого в баджере нет. Это нужно делать сверху или изнутри. Делать это сверху и изнутри достаточно неудобно, при условии, что нам на самом деле многие навороты баджера не то, чтобы были очень сильно нужны. То есть у нас почти нет обновления документов, а если есть, то очень редко. Но в баджере, тем не менее, есть история про компакшн, гарбиш коллекшн и всякое такое. И основная проблема возникает с ними. Почему? Потому что, помимо прочего, еще есть специфика системы, мы, к сожалению, не дошли до обсуждения вайтпейпера. Но в ней раз в 10 секунд меняются роли. То есть если ты был сейчас исполнителем контракта, проходит 10 секунд, ты можешь уже стать исполнителем контракта. И по этому принципу меняются роли достаточно часто. На всех нодах, не только на исполнителях инвалидаторов. Посыл такой, что система, она такая, не то чтобы реалтайм, но такая супер-суперсофт реалтайма. В ней не может что-то сильно затупить на секунду, например. А это именно то, что иногда делает баджер. То есть мы сталкиваемся с тем, что приложение работает, мы ничего особо не трогали, не писали, не запускали гарбиш коллекшн на баджере, но баджер в какой-то момент в самом фоне решил, что ему нужно очень много ходить в диск и запускать компакшн. Попытаться закомпактить слои. Хотя мы знаем, что мы особо не меняем данные, там особо компактить нечего. В смысле он может пытаться их слить в один слой, но это вряд ли даст существенное улучшение перформанса. Но он тем не менее пытается сделать. И когда он это делает, нода очень сильно тупит, ее выбрасывает из консенсуса, потому что мы пытаемся в византийский консенсус, а нода что-то не отвечает, наверное она умерла. И начинаются вот такие всякие истории. Плюс нужно делать бэкапы, инкрементальные бэкапы. Баджер умеет делать инкрементальные бэкапы, но он не рассчитывает на то, что этот инкрементальный бэкап ты будешь пытаться делать каждые 10 секунд. Инкрементальный бэкап на большой базе, большой в кавычках, большая это там типа 50 гигабайт, например. Короче, при инкрементальном бэкапе Баджер все равно сканирует всю базу, абсолютно всю. Ему все равно, что ты ему там какой-то флажок передал, типа мы бэкапим вот с такого курсора. Нам это тоже не подходит, потому что мы не укладываем все в наше… Ну у нас там есть очень сложный, который сейчас долго рассказывать, откуда они берутся, констрейнты, что время инкрементального бэкапа должно быть несколько секунд. Передать данные по сети, получить ак, что они ушли, и работать дальше. Баджер этого не предоставляет. Ну и вот когда ты сталкиваешься с первой проблемой, со второй, с третьей, с четвертой, ты понимаешь, что просто эта база данных в этом сценарии, в моём, она просто не подходит. Ну вот, как бы есть требования, они очень специфичные, и универсальная база данных, которая создавалась явно не для этого, она этим очень специфичным требованиями не удовлетворяет. Хотя база-то, она отличная, просто не для этой задачи, как выяснилось. Я ответил на вопрос? Да, вполне. Окей, ну то есть у нас очень левая резьба с очень странным шагом, который меняется, пока ты двигаешься по резьбе. Вот, Ваня, тебе слово. Да, слово мне, потому что я съездил на конференцию, которая называется Дивупс, и я хотел прибежаться вкратце, потому что мне там понравилось, что мне не понравилось. Во-первых, в конференции делается джугу, которая делает Джокер и прочие интересные конференции. Я не был ни на одной другой конференции, которая делает джугу, но Дивупс, он великолепен. Мне очень нравится как качество, с которым эта конференция делается, внимание к деталям, делаются прогоны с докладчиками по нескольку раз, программный комитет очень серьезно работает с тем, чтобы довести уровень докладов до какого-то хорошего уровня, простите за татологию, и некоторых мучают прям раз за разом, пока не добьются хорошего качества, и это прям очень сильно помогает держать марку. Получается, с одной стороны, очень высокое качество докладов, с другой стороны, как-то удается им заманить очень неплохих докладчиков, а они же делали Гидру, помните, недавно мы обсуждали Гидру, из-за которой я плакал, что не смог туда поехать, и они же как раз делают Дивупс. И получается прям замечательно, очень замечательно. Чем мне, чем не похожа эта конференция на остальные конференции, тем, что между докладами полчаса времени. Казалось бы, полчаса времени это прям, ну, довольно много. Во время обеденных перерывов, там даже 45 минут между докладами. С другой стороны, это позволяет очень хорошо помучать докладчика, и не торопиться, не бежать в другой зал, потому что начинается следующий доклад, и это прям хорошо влияет, то есть неспешно идет конференция, тебе не надо мчаться куда-то. Из докладов я хотел бы отметить следующее. Во-первых, они позвали Тима Тилистера, это тот человек, который соавтор книги Peopleware. Мы с ним, ну, я тоже докладывался, поэтому мы с ним в комнате докладчиков очень много болтали, беседовали, очень приятный дядька, он все жаловался на джетлэг, все волновался, что он не проснется к докладу. Вот мы ему говорили, вы не волнуйтесь, вас обязательно разбудят. Очень классно поболтали. Его доклад мне показался необычным, у него было всего, по-моему, два слайда. Это прям для меня было удивительно. Он по этим слайдам не торопясь шел в течение положенного времени, потом отвечал на вопросы. Очень интересно с точки зрения организации всего, что происходит в компании, в команде. Я не буду рассказывать, два слайда там совсем маленькие, если вам интересно, посмотрите. Все слайды уже сейчас доступны в материалах, все доклады будут через полгода. Из интересных я бы отметил еще... Так, сейчас, сейчас, сейчас, сейчас... А, вот, Алекс Фиссон, как говорится, он очень интересный человек, он как раз про флаггинги фичерс, он рассказывает на примере дотнетовских приложений в Ажуре, но разницы нет, то есть он просто рассказывает, почему фичи-флагги помогают, то, что мы сегодня обсуждали, какие бывают проблемы, ему задают вопросы, интересно послушать. Очень интересно выступил Хади Харири из JetBrains на закрывающий первый день. Это человек, который, как это называется, девелопер-адвокат в JetBrain, и он умеет разговаривать. Это настолько сильно вбрысается в глаза после моих предыдущих технических докладчиков, которые по сравнению с Хади, они просто вообще не умеют разговаривать, а он прям держит, шутки шутит, держит всю аудиторию, шутит шутки вовремя, смотрит, когда все начинают засыпать, какую-то веселую историю рассказывает, он прям вообще молодец. То есть он говорит прям ртом? Представляешь себе? Вот, это необычно. Он рассказывал про… ой, я сейчас даже не помню, какие он… Доклад у него называется «Removing the barriers», самый интересный у него, часть доклада, самый интересный факт у него в докладе, и для меня это было тоже интересно, откровение такое. Он рассказывал, что в JetBrain все приходили на работу всегда к 12. А потом в какой-то момент времени компания поняла, что это не очень удобно, потому что нет расписания, ничего такого, им захотелось ввести какую-то стандартизацию, и они сделали вот так вот, щелкнули пальцем, и люди стали приходить к 8, но самое позже к 8.30. Причем никого не заставляли, не просили, не вводили обязательств и так далее. Как они это сделали? Оказалось очень просто, они ввели завтраки. Завтраки были с 8 до полдевятого. И очень большое количество людей стало подтягиваться с 8 до полдевятого, а потом постепенно все поняли, что в принципе ты хочешь что-то обсудить, с утра это очень удобно обсуждать. Поэтому, говорит, вот так вот пара яиц и небольшой салатик, в смысле небольшой кусочек зелени заставляет всю компанию перейти на более ранний график работы. Ну и вот подобных интересных курьезов было очень много. Потом мне, я с удовольствием пошел на доклад Никиты Соболева про автоматизацию с GitHub App Actions. Ко мне к вам приходил недавно письмо счастья, что GitHub Actions будет в ноябре, выходит на General Availability. Мне было очень интересно посмотреть, о чем это, и Никита здорово рассказал. Я тебе больше скажу, я его даже запользовал, пока тебя не было. Да? Вообще классно. Да. Вот я собираюсь на него перейти с несколькими open source проектами, потому что ну прям, судя по всему, это очень удобно. Вот, если вы хотите как раз про это посмотреть, посмотрите доклад, через полгода правда, Никиты Соболева. И, и, и, да, и очень советую, очень советую посмотреть заключающий кино от Романа Шапошникова. Почему IT-индустрия переживает темные времена, как в этом виноват DevOps, и почему капитал может помочь. Капитал это в смысле в кавычках маркса. Роман Шапошников, он в совете директоров Linux Foundation и в совете директоров Apache Foundation. И он рассказывал про, его мнение с точки зрения вот этих вот тех постов, которые он занимает, будущего open source, про будущее интернета в целом и про будущее технологии, которые точно должны выстрелить, ну по его мнению. Вот, было очень интересно посмотреть, послушать, и я всем советую, вот кто пытается как-то следить за какими-то статьями, в которых делается аналитика того, что может произойти, вот его доклад. Как-то так. А, ну и посмотрите, конечно, мой доклад. Я там докладывал про невыносимую, невыносимую легкость масштабирования в Kubernetes. Мне, когда перед самым докладом в комнате с докладчиками, меня очень здорово пошутили, сказали, что весь этот, весь этот девопс посвящен Kubernetes, куда не придешь, какую-то комнату или на какой доклад, все время слышишь. Кубернетес, кубернетес, кубернетес, мне сказали, Ваня, вот ты сможешь свой доклад рассказать, ни разу не упомяну слово кубернетес. Вот, я подумал, что все-таки, наверное, не смогу, поэтому пришлось упоминать. А так, наверное, веселый такой челлендж, веселая затея, попытаться подобный доклад рассказать, не упомянув. название продукта. На этом всё. Так может называть как-нибудь куберконф или как-нибудь так? Ну там не только про это, но кубернетов там полно. Окей, окей. Чего ещё полно, это тема наших слушателей. Тут сам доля нет. Да, да-да. Ну ладно, я пытался. Мы хотим что-нибудь обсудить как бы вне наголосованного, потому что голосов нет. И мы не хотим обсудить ничего вне наголосованного. Ну окей, это значит, что во-первых… Подожди, подожди, а там вот «Локали ненадёжны». Я не читал тему, вот я сейчас только что открыл, но «Локали ненадёжны» мне кажется, это всегда в тему нашего подкаста. Как-то там Валер сказал про ненадёжность, надо переименовать подкаст. Пропаганда ненадёжности. Да, да, да. Мне кажется, хорошее название для подкаста. Я что-то занят. Устарело уже как-то. Таммен придётся менять. Чёрт, точно. Сложно слишком. Ну ребят, простите. Представляешь… На самом деле, если я правильно смотрел, про что там тема в «Ненадёжные локали», там просто, не знаю, какое-то такое желчеизлияние очень резкое случилось у автора. То есть, там может быть поделано, но это тяжело читать, в силу того, что слог, не знаю, как будто Линус Торвальдс бывает… Кипит говном. Худшее в свои дни. Да, да. Вот тут весь коммитменсаж написан в таком стиле, про там «брейн дэсс» и вот это всё, и мне сквозь этот язык довольно тяжело продираться. То есть, как бы… Там бы не помешал TLDR по сути. Вот это вот, не знаю, очень много боли, которые отчасти, наверное, можно понять, но, наверное, можно было написать лучше и понятнее, короче, с меньшим количеством злых аппетитов. Приносите нам больше тем, голосуйте за них активнее, и тогда они непременно попадут в выпуск. А иначе…",
    "result": {
      "query": "Timescale vs Postgres for timeseries"
    }
  }
]